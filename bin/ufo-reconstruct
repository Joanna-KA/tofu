#!/usr/bin/env python

import os
import sys
import re
import glob
import argparse
import logging
import numpy as np
from gi.repository import Ufo
from tofu import config


LOG = logging.getLogger(__name__)


def init(args):
    if not os.path.exists(config.NAME):
        config.write()
    else:
        sys.exit("{0} already exists".format(config.NAME))


def run_tomo(args):
    from tofu import reco
    reco.tomo(args)


def run_lamino(args):
    from tofu import reco
    reco.lamino(args)


def gui(args):
    from tofu import gui
    gui.main(args)


def estimate(args, cfg_parser):
    from tofu import reco
    sinos = sorted(glob.glob(os.path.join(args.input, '*.tif')))

    if not sinos:
        sys.exit("No valid input")

    middle = sinos[len(sinos) / 2]
    center = reco.estimate_center(cfg_parser, middle, args.num_iterations)
    print(">>> Best axis of rotation: {}".format(center))


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument('-v', '--verbose', action='store_true',
                        help="Verbose output")

    subparsers = parser.add_subparsers(title="Commands", metavar='')

    # init parser
    cmd_parser = subparsers.add_parser('init', help="Create a configuration file")
    cmd_parser.set_defaults(func=init)

    # tomo parser
    tomo_params = config.TomoParams()
    cmd_parser = subparsers.add_parser('tomo', help="Run tomographic reconstruction")
    cmd_parser = tomo_params.add_arguments(cmd_parser)
    cmd_parser.set_defaults(func=run_tomo, **tomo_params.file_params)

    # gui parser
    gui_params = config.TomoParams(sections=('gui',))
    cmd_parser = subparsers.add_parser('gui', help="GUI for tomographic reconstruction")
    cmd_parser = gui_params.add_arguments(cmd_parser)
    cmd_parser.set_defaults(func=gui, **gui_params.file_params)

    # lamino parser
    lamino_params = config.LaminoParams()
    cmd_parser = subparsers.add_parser('lamino', help="Run laminographic reconstruction")
    cmd_parser = lamino_params.add_arguments(cmd_parser)
    cmd_parser.set_defaults(func=run_lamino, **lamino_params.file_params)

    # estimate parser
    cmd_parser = subparsers.add_parser('estimate',
                                       help="Estimate center of rotation")

    cmd_parser.set_defaults(func=estimate, params=None)

    cmd_parser.add_argument('--num-iterations', type=int, default=10, metavar='N',
                            help="Number of iterations")

    # parse args and update parameter structures
    args = parser.parse_args()

    if args.verbose:
        logging.basicConfig(level=logging.INFO)

    args.func(args)


if __name__ == '__main__':
    main()

# vim: ft=python
